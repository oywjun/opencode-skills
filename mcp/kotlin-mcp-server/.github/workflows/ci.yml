name: CI
permissions:
  contents: read

on:
  push:
    branches: [ main, feature/ai-intelligence-enhancements ]
  pull_request:
    branches: [ main ]

jobs:
  build-sidecar:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build Kotlin sidecar
      run: |
        cd kotlin-sidecar
        ./gradlew shadowJar
    
    - name: Upload sidecar JAR
      uses: actions/upload-artifact@v4
      with:
        name: kotlin-sidecar
        path: kotlin-sidecar/build/libs/kotlin-sidecar.jar

  python-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Python tests
      run: |
        python -m pytest tests/ -v

  e2e-android:
    runs-on: ubuntu-latest
    needs: build-sidecar
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Download sidecar JAR
      uses: actions/download-artifact@v4
      with:
        name: kotlin-sidecar
        path: kotlin-sidecar/build/libs/
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run E2E Android generation
      run: |
        python e2e_test.py e2e/sampleapp
    
    - name: Build Android app
      run: |
        cd e2e/sampleapp
        ./gradlew assembleDebug testDebugUnitTest lint spotlessCheck detekt
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: sample-app-apk
        path: e2e/sampleapp/app/build/outputs/apk/debug/app-debug.apk
    
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          e2e/sampleapp/app/build/reports/
          e2e/sampleapp/build/reports/
    
    - name: Check APK exists
      run: |
        if [ -f "e2e/sampleapp/app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "‚úÖ APK successfully generated"
          ls -la e2e/sampleapp/app/build/outputs/apk/debug/
        else
          echo "‚ùå APK not found"
          exit 1
        fi

  schema-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate MCP schemas
      run: |
        python -c "
        import json
        import os
        from pathlib import Path
        
        schema_path = Path('schema/mcp-tools.schema.json')
        if schema_path.exists():
            with open(schema_path) as f:
                schema = json.load(f)
            print('‚úÖ MCP tools schema is valid JSON')
            
            # Check for required Android tools
            tools = schema.get('properties', {})
            android_tools = ['androidSetupArchitecture', 'androidSetupDataLayer', 'androidSetupNetwork', 'androidGenerateComposeUI']
            for tool in android_tools:
                if tool in tools:
                    print(f'‚úÖ {tool} schema defined')
                else:
                    print(f'‚ùå {tool} schema missing')
                    exit(1)
        else:
            print('‚ùå Schema file not found')
            exit(1)
        "

  performance-check:
    runs-on: ubuntu-latest
    needs: build-sidecar
    steps:
    - uses: actions/checkout@v4
    
    - name: Download sidecar JAR
      uses: actions/download-artifact@v4
      with:
        name: kotlin-sidecar
        path: kotlin-sidecar/build/libs/
    
    - name: Run performance tests
      run: |
        python -c "
        import asyncio
        import time
        from sidecar_client import SidecarClient
        
        async def perf_test():
            client = SidecarClient()
            await client.ensure_sidecar_running()
            
            # Test refactor function performance
            start = time.time()
            response = await client.call_sidecar('refactorFunction', {
                'filePath': 'test.kt',
                'functionName': 'testFunction',
                'refactorType': 'rename',
                'newName': 'renamedFunction'
            })
            duration = time.time() - start
            
            print(f'üîß Refactor function: {duration:.3f}s')
            if duration > 1.0:
                print('‚ö†Ô∏è  Performance warning: refactor took longer than 1s')
            
            # Test format code performance
            start = time.time()
            response = await client.call_sidecar('formatCode', {
                'targets': ['kotlin-sidecar/src'],
                'style': 'ktlint'
            })
            duration = time.time() - start
            
            print(f'üìù Format code: {duration:.3f}s')
            if duration > 2.0:
                print('‚ö†Ô∏è  Performance warning: format took longer than 2s')
        
        asyncio.run(perf_test())
        "
